events {}

http {
  types {
    application/x-mpegURL        m3u8;
    video/MP2T                   ts;
  }

  server {
    listen 8080;
    server_name localhost;

    root /usr/share/nginx/html;
    autoindex off;

    # ── Master / media playlists (.m3u8) ──
    location ~* \.m3u8$ {
      # OPTIONS preflight — just return 204, no add_header needed inside if
      if ($request_method = OPTIONS) {
        return 204;
      }
      add_header Content-Type "application/x-mpegURL";
      add_header Cache-Control "no-cache, no-store, must-revalidate";
      add_header Pragma "no-cache";
      add_header Expires "0";
      add_header Access-Control-Allow-Origin "*";
      add_header Access-Control-Allow-Methods "GET, OPTIONS";
      add_header Access-Control-Allow-Headers "Range, Accept, Origin";
      try_files $uri =404;
    }

    # ── TS segments ──
    location ~* \.ts$ {
      if ($request_method = OPTIONS) {
        return 204;
      }
      add_header Content-Type "video/MP2T";
      add_header Cache-Control "max-age=10";
      add_header Access-Control-Allow-Origin "*";
      add_header Access-Control-Allow-Methods "GET, OPTIONS";
      add_header Access-Control-Allow-Headers "Range, Accept, Origin";
      try_files $uri =404;
    }
  }
}