# ─────────────────────────────────────────────────────────────
#  RAI Live → local HLS restream
#
#  Architecture:
#    streamlink ──(TS stdout)──▶ FIFO ──▶ ffmpeg ──(HLS segments)──▶ nginx
#
#  Access the stream at:  http://localhost:8080/stream.m3u8
# ─────────────────────────────────────────────────────────────

services:

  # ── 1. Streamlink: pulls the RAI stream, writes raw MPEG-TS to a FIFO ──
  streamlink:
    build:
      context: .
      dockerfile: Dockerfile.streamlink
    volumes:
      - pipe:/shared          # tmpfs shared with ffmpeg
    environment:
      - STREAM_URL=${STREAM_URL:-https://mediapolis.rai.it/relinker/relinkerServlet.htm?cont=358025&output=16}
      - STREAM_QUALITY=${STREAM_QUALITY:-best}
    restart: unless-stopped
    depends_on:
      ffmpeg:                 # ffmpeg must be ready to read the FIFO first
        condition: service_started

  # ── 2. FFmpeg: reads TS from the FIFO, segments it into HLS ──
  ffmpeg:
    build:
      context: .
      dockerfile: Dockerfile.ffmpeg
    volumes:
      - pipe:/shared          # reads /shared/input.ts  (FIFO)
      - hls:/shared/hls       # writes HLS output here
    restart: unless-stopped

  # ── 3. Nginx: serves the HLS playlist + segments over HTTP ──
  nginx:
    image: nginx:1.27-alpine
    volumes:
      - hls:/usr/share/nginx/html   # same HLS output dir
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "${HLS_PORT:-8080}:8080"
    restart: unless-stopped
    depends_on:
      - ffmpeg

# ── Volumes ──
volumes:
  pipe:                       # tmpfs: zero-disk-IO for the FIFO
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=64m
  hls:                        # tmpfs: HLS segments are ephemeral
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=256m